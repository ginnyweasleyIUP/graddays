---
title: "Monday: Ice age rhythms"
output: html_notebook
---

Investigating the temp-variability relationship on long timescales: Illustration using the LRO4 stack;


# Benthic oxygen isotope variability: Temperature variability over the last 5 Million years
## Setup
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
setwd("~/R/spielwiese/graddays/")
library(zoo)
outputdir="~/R/spielwiese/graddays/results"



```


## Read and plot the benthic stack
```{r Read and plot Benthic stack data}
## 1 Read data
dat<-read.csv(sprintf("Datasets/Monday/LR04stack.csv"),header=TRUE)
LR<-zoo(dat[,2],order.by=dat[,1])

#x11(width=12,height=8)
par(lwd=2,font=2,font.axis=2,font.lab=2,cex=2,mar=c(4,4,1,1),mfcol=c(1,2))
plot(LR,type="n",ylim=range(LR)[2:1],xlab="",ylab="")
axis(1,at=seq(0,5)*10^3,labels=seq(0,5))
axis(2)
mtext("Age [Ma]",side=1,line=2,cex=1.5)
mtext("benthic d18O (T/ice vol)",side=2,line=2,cex=1.5)
text(4*10^3,range(LR)[2],"Lisiecki & Raymo, 2004")
lines(LR)
#dev.copy2pdf(file=sprintf("%sLR04_MeanVsStd-a.pdf",outputdir),out.type="pdf")

```

```{r Roughly calibrate to GMST change from Last Glacial Maximum to today}

par(lwd=2,font=2,font.axis=2,font.lab=2,cex=2,mar=c(4,4,1,1),mfcol=c(1,2))
plot(LR,type="n",ylim=range(LR)[2:1],xlab="",ylab="")
axis(1,at=seq(0,5)*10^3,labels=seq(0,5))
axis(2)
mtext("Age [Ma]",side=1,line=2,cex=1.5)
mtext("benthic d18O (T/ice vol)",side=2,line=2,cex=1.5)
text(4*10^3,range(LR)[2],"Lisiecki & Raymo, 2004")
lines(LR)

## 2 Rough calibration
tp<-c()
tp[1]<-length(which((index(LR)-5)<0))
tp[2]<-length(which((index(LR)-21)<0))
abline(v=index(LR)[tp],col="forestgreen",lwd=2)
abline(h=coredata(LR)[tp],col="forestgreen",lwd=2)
#dev.copy2pdf(file=sprintf("%sLR04_MeanVsStd-b.pdf",outputdir),out.type="pdf")

Cpermil<-diff(coredata(LR)[tp])/5 #permil per Kelvin
holoffset<- mean(window(LR,start=0,end=10))/(Cpermil*c(-1))
LR.T<-LR/Cpermil*c(-1) - holoffset

```
## Variance to mean relationship on million-year-timescale
```{r Compare mean and variance over last 5 Million years}

## 3 Obtain variance/mean
# ## cut this into windows, compute variance and mean in windows
M<-V<-c()
startpoints<-seq(start(LR.T),end(LR.T)-300,by=150)
for (i in 1:length(startpoints)){
ts.temp<-window(LR.T,start=startpoints[i],end=startpoints[i]+300)

M[i]<-mean(ts.temp)
V[i]<-var(ts.temp)
rm(ts.temp)
}

## 4 Plot
# x11(width=6,height=6)
# par(cex=2,font=2,lwd=2,mar=c(4,4,1,1))
plot(M,sqrt(V),xlab="",ylab="",pch=20,cex=3)
mtext("mean T/IceVol (wrt 0-5kyr)",side=1,line=2,cex=1.5)
mtext("std T/IceVol",side=2,line=2,cex=1.5)
grid()
# get rough slope and intercept
#dev.off()
#plot(lm(M~sqrt(V)))

##

plot(M,sqrt(V),type="n")
text(M,sqrt(V),1:length(V))

#x11()
par(cex=2,font=2,lwd=2,mar=c(4,4,1,1))
plot(M,sqrt(V)/(M+holoffset),xlab="",ylab="",pch=20)
mtext("mean (T/IceVol) [dK]",side=1,line=2,cex=2)
mtext("std/mean",side=2,line=2,cex=2)

```
## Spectral analysis

```{r Interpolation}

plot(index(LR)[-1],diff(index(LR)),xlab="kyrs BP",ylab="kyrs spacing")
# 
plot(LR,xlab="kyrs BP",ylab="benthic d18O")
intp<-approx(index(LR),coredata(LR),xout = seq(start(LR),end(LR),by=1))
LR.int<-zoo(intp$y,order.by=intp$x)
lines(LR.int,type="l",col="red")
legend("topright",c("raw","interpolated"),col=c("black","red"),lty=1)

```


```{r}

spec<-spectrum(as.ts(LR.int),plot=FALSE)
plot(1/spec$freq,spec$spec,log="xy",type="l",xlab="period [kyrs]",ylab="density")
abline(v=c(23,40,100),col="red")
```


```{r Compare first and last million years}

plot(LR.int)
lines(window(LR.int,start=3000,end=5000),col="red")
lines(window(LR.int,start=0,end=1000),col="blue")


spec.40k<-spectrum(window(LR.int,start=3000,end=5000),plot=FALSE)
spec.100k<-spectrum(window(LR.int,start=0,end=1000),plot=FALSE)


plot(1/spec$freq,spec$spec,"n",log="xy",xlim=c(10,250),xlab="period [kyrs]",ylab="spectral density")
lines(1/spec$freq,spec$spec)
lines(1/spec.40k$freq,spec.40k$spec,col="red")
lines(1/spec.100k$freq,spec.100k$spec,col="blue")
legend("bottomright",c("all 5 Myrs", "3-5 Myrs", "0-1 Myrs"),col=c("black","red","blue"),lty=1)
#read.csv("Datasets/Monday/edc3deuttemp2007.txt")

```

## Orbital forcing

```{r}
read.table("Datasets/Monday/orbit/insol91.jun",skip=3)
orbit<-read.table("Datasets/Monday/orbit/orbit91",skip=3)
colnames(orbit)<-c("kyrs BP","ecc","omega","obliquity","precession","65NJul","65SJan","15NJul","15SJan")


plot(orbit$`kyrs BP`,orbit$ecc)
plot(orbit$`65NJul`,type="l")
orb.65N<-zoo(orbit$`65NJul`,order.by=orbit$`kyrs BP`)

spec.insol.65N<-spectrum(orb.65N,plot=FALSE)
plot(1/spec.insol.65N$freq,spec.insol.65N$spec,log="xy",type="l",xlim=c(3,250),xlab="period [kyrs]",ylab="spectral density")

abline(v=c(19,23,40,100),col="red")
grid()
```
# Global mean temperature to atmospheric CO2 relationship
## Read ice core data
```{r}

EDC.temp<-read.csv("Datasets/Monday/EDC_deuterium_temp.csv",header = TRUE)
Antarctic_CO2<-read.csv("Datasets/Monday/antarctica2015co2_composite.csv")


head(Antarctic_CO2)
head(EDC.temp)
```


## Plot ice core data
```{r Plot temperature reconstruction and deuterium proxy data}
plot(EDC.temp$Age.model..ka.,EDC.temp$delta.T...C.,type="l",xlab="kyrs BP",ylab="temperature anomaly [K]")
par(new=TRUE)
plot(EDC.temp$Age.model..ka.,EDC.temp$δD....SMOW.,axes=FALSE,col="red",type="l",
     xlab="",ylab="")
axis(4)
mtext(side=4,"permil",col="red",line=-1)
```
## Plot CO2 data from ice core and check the resolution
```{r}
plot(Antarctic_CO2$Gasage..yr.BP.,Antarctic_CO2$CO2..ppmv.,type="l",xlab="gas age [yrs BP]",ylab="CO2 [ppmv]")



plot(Antarctic_CO2$Gasage..yr.BP.[-1],diff(Antarctic_CO2$Gasage..yr.BP.),xlab="gas age [yrs BP]", ylab="resolution [yrs]")



```
The resolution of the respective datasets is roughly 275 years (CO2 data) versus roughly 50 years (deuterium bag means). Therefore, interpolate both to lower resolution.

## Interpolate CO2 data
```{r}
median(diff(Antarctic_CO2$Gasage..yr.BP.))/1000
median(diff(EDC.temp$Age.model..ka.))

tscale<-seq(0,800,by=0.1)

EDC.interp<-as.data.frame(cbind(tscale,cbind(approx(Antarctic_CO2$Gasage..yr.BP./1000,Antarctic_CO2$CO2..ppmv.,tscale)$y,
approx(EDC.temp$Age.model..ka.,EDC.temp$δD....SMOW.,tscale)$y,
approx(EDC.temp$Age.model..ka.,EDC.temp$delta.T...C.,tscale)$y)))
colnames(EDC.interp)<-c("age [kyrs BP]","CO2 [ppmv]","dD [permil smow]","dT [C]")
```


## Overall relationships in the interpolated datasets
```{r}
pairs(EDC.interp)
```
## Regression analysis
```{r}

scatter.smooth(x=EDC.interp$`CO2 [ppmv]`, y=EDC.interp$`dT [C]`, main="CO2 ~ dT",col="blue")  # scatterplot

cor(EDC.interp$`CO2 [ppmv]`,EDC.interp$`dT [C]`,use = "pairwise.complete")

```
```{r}
# rename columns for simplicity
colnames(EDC.interp)<-c("age","co2","dD","dT")
plot(EDC.interp$co2,EDC.interp$dT,xlab="co2 [ppmv]",ylab="dT [C]")

m<-lm(dT~co2,data=EDC.interp)
abline(m,col="red")
m1 <-  summary(m)

mtext(paste0("R squared: ",round(m1$r.squared,2)),adj = 0)

mtext(paste0("P-value: ", format.pval(pf(m1$fstatistic[1], # F-statistic
                                     m1$fstatistic[2], # df
                                     m1$fstatistic[3], # df
                                     lower.tail = FALSE))))

mtext(paste0("dT ~ ",round(m1$coefficients[1],2)," + ",              round(m1$coefficients[2],2)," co2"),adj = 1)

```
## Extrapolation of this relationship (crude!)

Assuming that Antarctic temperatures reflect global mean temperature change, and that the CO2 to temperature relationship is constant, also neglecting the uncertainty in the calibration - what would be the temperature change for our current level of co2 in the atmosphere? 
```{r}
new.df <- data.frame(co2=c(180, 280, 300,350,400,410,450))
new.df$pred<-predict(m, new.df)

par(mar=c(4,4,0,4))
plot(EDC.interp$co2,EDC.interp$dT,xlim=c(170,450),ylim=c(-11,14),xlab="co2 [ppmv]",ylab="reconstructed Antarctic T")
text(new.df$co2,new.df$pred,new.df$co2,col="red",cex=1.1)
axis(4,at = 2.07*c(-5,0,5),c(-5,0,5))
mtext(side=4,"GMST change assuming PAF=2.07",line=3)
```

Note: The translation of Antarctic to global mean temperature change is assuming an Arctic amplification factor of 2.07 (Masson-Delmotte, 2005), see /Datasets/Tuesday/Masson-Delmotte*.pdf.





